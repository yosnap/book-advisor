// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// CORE ENTITIES - Recomendation System
// ============================================================================

/// Books in the catalog
model Book {
  id              String   @id @default(cuid())
  title           String   @unique
  author          String
  genre           String   @db.VarChar(100)
  synopsis        String   @db.Text
  difficulty      String?  @default("intermediate") // "beginner", "intermediate", "advanced"
  publicationYear Int?
  tags            String[] @default([])

  // Audit fields
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  recommendations RecommendationBook[]

  @@index([genre])
  @@index([author])
}

/// Reader context and preferences
model ReaderContext {
  id               String   @id @default(cuid())
  userId           String   @unique

  // Current state
  mood             String   // "feliz", "triste", "reflexivo", "ansioso", "neutral"
  readerProfile    String   // "novato", "intermedio", "avanzado", "experto"
  interests        String[] @default([])
  intent           String   // "relax", "aprendizaje", "evasión"

  // Preferences (JSON for flexibility)
  preferences      Json?

  // Historical data
  previousMoods    String[] @default([])
  readBooks        String[] @default([]) // Array of book IDs

  // Metadata
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  lastAccessedAt   DateTime @updatedAt

  // Relations
  recommendations  Recommendation[]

  @@index([userId])
  @@index([mood])
  @@index([readerProfile])
}

/// Recommendations generated by the system
model Recommendation {
  id               String   @id @default(cuid())

  // Reference to reader context
  contextId        String
  context          ReaderContext @relation(fields: [contextId], references: [id], onDelete: Cascade)

  // Recommendation data (JSON for flexibility)
  books            RecommendationBook[]

  // Metadata
  totalScore       Float?   @default(0.0) // Average score
  processingTime   Int?     // milliseconds
  agentsUsed       String[] @default([])
  errors           String[] @default([])

  // Feedback
  feedback         String?  // User feedback on recommendations
  feedbackScore    Int?     // 1-5 rating

  // Audit
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([contextId])
  @@index([createdAt])
}

/// Junction table for books in a recommendation
model RecommendationBook {
  id               String   @id @default(cuid())

  recommendationId String
  recommendation   Recommendation @relation(fields: [recommendationId], references: [id], onDelete: Cascade)

  bookId           String
  book             Book @relation(fields: [bookId], references: [id], onDelete: Restrict)

  // Score and justification
  score            Float    @default(0.0) // 0-1
  scoreBreakdown   Json?    // { moodMatch: 0.9, profileMatch: 0.8, ... }

  justification    String   @db.Text
  keyReasons       String[] @default([])

  // Ranking
  rank             Int      @default(0) // Position in recommendations

  createdAt        DateTime @default(now())

  @@unique([recommendationId, bookId])
  @@index([bookId])
  @@index([recommendationId])
}

// ============================================================================
// ADMIN & USER MANAGEMENT
// ============================================================================

/// Admin users for dashboard
model AdminUser {
  id               String   @id @default(cuid())
  email            String   @unique
  name             String
  hashedPassword   String
  role             String   @default("editor") // "viewer", "editor", "admin"

  // Permissions
  canCreateBooks   Boolean  @default(true)
  canEditBooks     Boolean  @default(true)
  canDeleteBooks   Boolean  @default(false)
  canViewStats     Boolean  @default(true)

  // Audit
  lastLoginAt      DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([email])
}

// ============================================================================
// AUDIT & LOGGING
// ============================================================================

/// Audit log for tracking all important operations
model AuditLog {
  id               String   @id @default(cuid())

  // What happened
  entityType       String   // "book", "recommendation", "admin_user", etc.
  entityId         String
  action           String   // "created", "updated", "deleted", "accessed"

  // Who did it
  userId           String?
  adminUserId      String?

  // Change details
  oldData           Json?
  newData           Json?

  // Metadata
  ipAddress        String?
  userAgent        String?

  createdAt        DateTime @default(now())

  @@index([entityType])
  @@index([entityId])
  @@index([userId])
  @@index([createdAt])
}

// ============================================================================
// CACHING & SESSION MANAGEMENT
// ============================================================================

/// Cache for frequently accessed data
model Cache {
  id               String   @id
  key              String   @unique
  value            Json
  expiresAt        DateTime

  createdAt        DateTime @default(now())

  @@index([expiresAt])
}

/// User sessions for multi-channel support
model UserSession {
  id               String   @id @default(cuid())
  userId           String

  // Session data
  channel          String   // "web", "telegram", "mobile"
  sessionToken     String   @unique

  // Location/Device info
  ipAddress        String?
  userAgent        String?

  // Timing
  expiresAt        DateTime
  lastActivityAt   DateTime @updatedAt
  createdAt        DateTime @default(now())

  @@index([userId])
  @@index([sessionToken])
  @@index([channel])
  @@index([expiresAt])
}

// ============================================================================
// ANALYTICS
// ============================================================================

/// Track recommendation metrics
model RecommendationMetric {
  id               String   @id @default(cuid())

  recommendationId String

  // Metrics
  userAccepted     Boolean?  // Did user like the recommendation?
  booksClicked     String[]  @default([]) // Which books user clicked
  booksPurchased   String[]  @default([]) // Which books user purchased (from integrations)

  // Timing
  viewedAt         DateTime?
  clickedAt        DateTime?
  purchasedAt      DateTime?

  createdAt        DateTime  @default(now())

  @@index([recommendationId])
  @@index([userAccepted])
}

/// Aggregate stats for dashboards
model DailyStats {
  id                  String   @id @default(cuid())

  date                DateTime @unique

  // Counts
  totalRecommendations Int    @default(0)
  totalReadersActive  Int     @default(0)
  avgProcessingTime   Float   @default(0.0)

  // Top genres
  topGenres           Json    // { "ficción": 45, "historia": 32, ... }

  // Success metrics
  avgScore            Float   @default(0.0)
  acceptanceRate      Float   @default(0.0) // % of positive feedback

  createdAt           DateTime @default(now())

  @@index([date])
}
